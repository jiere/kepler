name: Platform Validation

on:
  workflow_dispatch:

env:
  GO_VERSION: "1.18"
  OUTPUT_DIR: "_output/"
  KEPLER_FILE_NAME: "kepler.tar.gz"
  VALIDATOR_FILE_NAME: "validator.tar.gz"
  ARTIFACT_DIR: "/tmp/artifacts"

jobs:
  build-artifacts:
    runs-on: [self-hosted, linux, x64]
    steps:
      - name: checkout source
        uses: actions/checkout@v3

      - name: install Go
        uses: actions/setup-go@v3
        with:
          go-version: ${{env.GO_VERSION}}

      - name: build and export Kepler image
        run: |
          make build_containerized
          make save-image
        env:
          IMAGE_REPO: "localhost:5001"
          IMAGE_NAME: "kepler"
          IMAGE_TAG: "devel"
          CTR_CMD: docker
          IMAGE_OUTPUT_PATH: ${{env.OUTPUT_DIR}}${{env.KEPLER_FILE_NAME}}

      - name: save Kepler image as artifact
        uses: actions/upload-artifact@v3
        with:
          name: kepler
          path: ${{env.OUTPUT_DIR}}${{env.KEPLER_FILE_NAME}}
          retention-days: 1

      - name: build and export platform-validation test image
        run: |
          make build-validation-container
          make save-image
        env:
          IMAGE_REPO: "localhost:5001"
          IMAGE_NAME: "platform-validation"
          IMAGE_TAG: "x86-rapl"
          CTR_CMD: docker
          IMAGE_OUTPUT_PATH: ${{env.OUTPUT_DIR}}${{env.VALIDATOR_FILE_NAME}}

      - name: save platform-validation image as artifact
        uses: actions/upload-artifact@v3
        with:
          name: validator
          path: ${{env.OUTPUT_DIR}}${{env.VALIDATOR_FILE_NAME}}
          retention-days: 1

  platform_validation_test:
    needs: [build-artifacts]
    runs-on: [self-hosted, linux, x64]
    strategy:
      matrix:
        cluster_provider: [kind]
    steps:
      - name: checkout source
        uses: actions/checkout@v3

      - name: download Kepler image artifact
        uses: actions/download-artifact@v3
        with:
          name: kepler

      - name: download platform-validation image artifact
        uses: actions/download-artifact@v3
        with:
          name: validator

      - name: build manifest
        run: make build-manifest OPTS="CI_DEPLOY PROMETHEUS_DEPLOY"
        env:
          CLUSTER_PROVIDER: ${{matrix.cluster_provider}}
          IMAGE_REPO: "localhost:5001"
          IMAGE_TAG: "devel"
          CTR_CMD: docker

      - name: import Kepler image
        run: make load-image
        env:
          IMAGE_REPO: "localhost:5001"
          IMAGE_NAME: "kepler"
          IMAGE_TAG: "devel"
          CTR_CMD: docker
          INPUT_PATH: ${{env.KEPLER_FILE_NAME}}

      - name: import platform-validation image
        run: make load-image
        env:
          IMAGE_REPO: "localhost:5001"
          IMAGE_NAME: "platform-validation"
          IMAGE_TAG: "x86-rapl"
          CTR_CMD: docker
          INPUT_PATH: ${{env.VALIDATOR_FILE_NAME}}

      - name: get Node component power before deploy kind cluster
        run: |
          make get-power
        env:
          IMAGE_REPO: "localhost:5001"
          IMAGE_NAME: "platform-validation"
          IMAGE_TAG: "x86-rapl"
          CTR_CMD: docker

      - name: use Kepler action to deploy cluster
        uses: sustainable-computing-io/kepler-action@v0.0.1
        with:
          runningBranch: ${{matrix.cluster_provider}}
          cluster_provider: ${{matrix.cluster_provider}}
          local_dev_cluster_version: v0.0.3
          prometheus_enable: true
          grafana_enable: true

      - name: push Kepler image to local registry
        run: |
          make push-image
        env:
          IMAGE_REPO: "localhost:5001"
          IMAGE_NAME: "kepler"
          IMAGE_TAG: "devel"
          CTR_CMD: docker

      - name: push platform-validation image to local registry
        run: |
          make push-image
          make image-prune
        env:
          IMAGE_REPO: "localhost:5001"
          IMAGE_NAME: "platform-validation"
          IMAGE_TAG: "x86-rapl"
          CTR_CMD: docker

      - name: get Node component power before deploy kepler
        run: |
          make get-power
        env:
          IMAGE_REPO: "localhost:5001"
          IMAGE_NAME: "platform-validation"
          IMAGE_TAG: "x86-rapl"
          CTR_CMD: docker

      - name: deploy Kepler on cluster
        run: make cluster-deploy
        env:
          CLUSTER_PROVIDER: ${{matrix.cluster_provider}}
          IMAGE_REPO: "localhost:5001"
          IMAGE_TAG: "devel"
          CTR_CMD: docker

      - name: Save artifacts
        if: ${{ failure() }}
        uses: actions/upload-artifact@v3
        with:
          name: artifacts
          path: ${{env.ARTIFACT_DIR}}
          retention-days: 10

      - name: run platform validation tests
        run: make platform-validation
        env:
          CLUSTER_PROVIDER: ${{matrix.cluster_provider}}
          IMAGE_REPO: "localhost:5001"
          IMAGE_NAME: "platform-validation"
          IMAGE_TAG: "x86-rapl"
          CTR_CMD: docker
          kepler_address: localhost:9102
          prometheus_address: localhost:9090

      - name: undeploy Kepler and cleanup the cluster
        run: |
          make cluster-clean
          make cluster-down
        env:
          CLUSTER_PROVIDER: ${{matrix.cluster_provider}}
